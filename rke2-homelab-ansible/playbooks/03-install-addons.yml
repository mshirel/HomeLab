---
- name: Install Kubernetes add-ons and applications
  hosts: rke2_masters[0]
  gather_facts: true
  become: true

  pre_tasks:
    - name: Display add-on installation start
      ansible.builtin.debug:
        msg: "Starting installation of cluster add-ons"

    - name: Check if CLOUDFLARE_API_TOKEN is set
      ansible.builtin.fail:
        msg: |
          ERROR: CLOUDFLARE_API_TOKEN environment variable is not set!

          Please set it before running this playbook:
          export CLOUDFLARE_API_TOKEN="your_cloudflare_token"
      when: lookup('env', 'CLOUDFLARE_API_TOKEN') | length == 0
      delegate_to: localhost
      run_once: true

    - name: Check if ACME_EMAIL is set
      ansible.builtin.fail:
        msg: |
          ERROR: ACME_EMAIL environment variable is not set!

          Please set it before running this playbook:
          export ACME_EMAIL="your-email@example.com"
      when: lookup('env', 'ACME_EMAIL') | length == 0
      delegate_to: localhost
      run_once: true

    - name: Display environment variables status
      ansible.builtin.debug:
        msg: |
          Environment variables verified:
          - CLOUDFLARE_API_TOKEN: Set ({{ lookup('env', 'CLOUDFLARE_API_TOKEN') | length }} characters)
          - ACME_EMAIL: {{ lookup('env', 'ACME_EMAIL') }}
      run_once: true

    - name: Install Python Kubernetes dependencies
      ansible.builtin.apt:
        name:
          - python3-kubernetes
          - python3-yaml
        state: present
        update_cache: true

    - name: Verify kubectl is available
      ansible.builtin.command: kubectl version --client
      register: kubectl_version
      changed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

  roles:
    - role: cilium
      tags: [cilium, cni, networking]

    - role: longhorn
      tags: [longhorn, storage]

    - role: traefik-ingress
      tags: [traefik, ingress]

    - role: test-apps
      tags: [test-apps, apps]

  post_tasks:
    - name: Wait for all pods to be running
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get pods -A --no-headers | grep -v "Running\|Completed" || true
      args:
        executable: /bin/bash
      register: pending_pods
      until: pending_pods.stdout_lines | length == 0
      retries: 30
      delay: 10
      changed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Get all pods status
      ansible.builtin.command: kubectl get pods -A -o wide
      register: all_pods
      changed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Display all pods
      ansible.builtin.debug:
        msg: "{{ all_pods.stdout_lines }}"

    - name: Get ingress resources
      ansible.builtin.command: kubectl get ingress -A
      register: ingress_resources
      changed_when: false
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Display ingress resources
      ansible.builtin.debug:
        msg: "{{ ingress_resources.stdout_lines }}"

    - name: Display access information
      ansible.builtin.debug:
        msg: |
          ========================================
          Cluster Setup Complete!
          ========================================

          Longhorn UI: https://longhorn.{{ ingress_domain }}
          Test App 1:  https://nginx.{{ ingress_domain }}
          Test App 2:  https://nginx-pvc.{{ ingress_domain }}

          Next steps:
          1. Configure external Traefik to forward *.{{ ingress_domain }} to workers on ports {{ ingress_http_nodeport }}/{{ ingress_https_nodeport }}
          2. Verify DNS records for the above domains
          3. Wait a few minutes for Let's Encrypt certificates to be issued
          4. Access the applications via HTTPS

          Useful commands:
          - kubectl get nodes
          - kubectl get pods -A
          - kubectl -n kube-system exec -it ds/cilium -- cilium status
          - hubble observe
          - k9s (on master nodes)
