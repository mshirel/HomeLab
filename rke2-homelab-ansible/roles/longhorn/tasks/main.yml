---
- name: Create Longhorn namespace
  kubernetes.core.k8s:
    name: "{{ longhorn_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Add Longhorn Helm repository
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Deploy Longhorn
  kubernetes.core.helm:
    name: longhorn
    chart_ref: longhorn/longhorn
    chart_version: "{{ longhorn_version }}"
    release_namespace: "{{ longhorn_namespace }}"
    create_namespace: false
    values:
      defaultSettings:
        defaultReplicaCount: "{{ longhorn_default_replica_count }}"
        defaultDataLocality: "{{ longhorn_default_data_locality }}"
        defaultLonghornStaticStorageClass: longhorn
      longhornManager:
        nodeSelector:
          storage-node: "true"
      longhornDriver:
        nodeSelector:
          storage-node: "true"
      persistence:
        defaultClass: true
        defaultClassReplicaCount: "{{ longhorn_default_replica_count }}"
        reclaimPolicy: "{{ longhorn_default_reclaim_policy }}"
      ingress:
        enabled: false  # We'll create our own ingress
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Wait for Longhorn to be ready
  ansible.builtin.command: >
    kubectl wait --for=condition=ready pod
    -l app=longhorn-manager
    -n {{ longhorn_namespace }}
    --timeout=600s
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  changed_when: false

- name: Create Longhorn UI ingress
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'longhorn-ingress.yaml.j2') | from_yaml }}"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  when: longhorn_ui_enabled | bool

- name: Get Longhorn system status
  ansible.builtin.command: kubectl get pods -n {{ longhorn_namespace }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: longhorn_pods
  changed_when: false

- name: Display Longhorn status
  ansible.builtin.debug:
    msg: "{{ longhorn_pods.stdout_lines }}"
